<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>src/client/md_device.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>src/client/md_device.cpp</h1><a href="md__device_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// This is the main DLL file.</span>
<a name="l00002"></a>00002 
<a name="l00003"></a><a class="code" href="md__device_8cpp.html#153f7c71f334e33080482cc53d1ce411">00003</a> <span class="preprocessor">#define DV_DLL</span>
<a name="l00004"></a><a class="code" href="md__device_8cpp.html#82a53a294e1365c870ce2ec3f672a789">00004</a> <span class="preprocessor"></span><span class="preprocessor">#define DV_DLL_MAIN</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="md__device_8h.html">md_device.h</a>"</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="mdBehavior_8h.html">mdBehavior.h</a>"</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "../server/Listener.cpp"</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include "../server/EventSender.cpp"</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011  <span class="keyword">extern</span> boost::mutex                    <a class="code" href="deviceDaemon_8cpp.html#d2a7ce1ced9c7eea9c156d50f7d69e7f">mdQuery</a>;
<a name="l00012"></a>00012  <span class="keyword">extern</span> boost::condition_variable <a class="code" href="deviceDaemon_8cpp.html#77ade0f201886e0de643f4ac654ead0d">mdObsQPending</a>;
<a name="l00013"></a>00013  <span class="keyword">extern</span> boost::condition_variable <a class="code" href="deviceDaemon_8cpp.html#964c4495a2919228f61898e2197a7453">mdODEQPending</a>;
<a name="l00014"></a>00014  <span class="keyword">extern</span> boost::condition_variable <a class="code" href="deviceDaemon_8cpp.html#ce6d1703ac51bcc1d544eca186b40557">mdCmdQPending</a>;
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="keywordtype">void</span> <a class="code" href="deviceDaemon_8cpp.html#7567931fa56e4616002507599be302e9">runEmbedded</a>();
<a name="l00017"></a>00017 <span class="keywordtype">void</span> <a class="code" href="clientDaemon_8cpp.html#0ee660fd919ae2d40b3121233169ee00">runDataLayer</a>();
<a name="l00018"></a>00018 <span class="keywordtype">void</span> <a class="code" href="deviceDaemon_8cpp.html#e12b69b7916e6e2829e3865145ba6cda">setStrMsg</a>(<a class="code" href="classmdDG.html">mdDG</a> &amp;mdg,<span class="keyword">const</span> <span class="keywordtype">char</span> *str,
<a name="l00019"></a>00019                <a class="code" href="mdcommon_8h.html#fcc5cc24102ccd9a8e45227ea5ddeddd">mdDGtype</a> md_DG_type,<a class="code" href="mdcommon_8h.html#fcc5cc24102ccd9a8e45227ea5ddeddd">mdDGtype</a> md_DG_subtype,
<a name="l00020"></a>00020                <span class="keyword">const</span> <span class="keywordtype">char</span> *extraTxt  );
<a name="l00021"></a><a class="code" href="md__device_8h.html#8511de0455ea917d0283762445ec4c7d">00021</a> <span class="keywordtype">bool</span> <a class="code" href="md__device_8cpp.html#8511de0455ea917d0283762445ec4c7d">aucDevice</a>() {
<a name="l00022"></a>00022 
<a name="l00023"></a>00023   <span class="keywordtype">bool</span> value=<span class="keyword">true</span>;
<a name="l00024"></a>00024 
<a name="l00025"></a>00025   <span class="keywordflow">try</span> {
<a name="l00026"></a>00026 
<a name="l00027"></a>00027   <a class="code" href="auc-cd_8h.html#e73e5747d151dd3f1a0b8ba29bfaa3e6">thisConfig</a> = <span class="keyword">new</span> <a class="code" href="classdeviceDaemonConfig.html">deviceDaemonConfig</a>();
<a name="l00028"></a>00028   <a class="code" href="auc-cd_8h.html#b497b0c636c3df3eaf60698ac8a89c0c">theseLogs</a>.<a class="code" href="classcdLogger.html#aaab60abf3018e270cebc6db9715e2d8">init</a>(<span class="stringliteral">"auc-dv"</span>);
<a name="l00029"></a>00029   <a class="code" href="auc-cd_8h.html#b497b0c636c3df3eaf60698ac8a89c0c">theseLogs</a>.<a class="code" href="classcdLogger.html#c8209410afb905787efbd8f49499523b">logN</a>(0,DV_NAME <span class="stringliteral">" "</span> DV_VERSION <span class="stringliteral">" compiled on "</span> __DATE__ <span class="stringliteral">" @ "</span> __TIME__); 
<a name="l00030"></a>00030   <a class="code" href="auc-cd_8h.html#b497b0c636c3df3eaf60698ac8a89c0c">theseLogs</a>.<a class="code" href="classcdLogger.html#c8209410afb905787efbd8f49499523b">logN</a>(0,<span class="stringliteral">"Embedded processing begun."</span>);    
<a name="l00031"></a>00031 
<a name="l00032"></a>00032    boost::thread fg(<a class="code" href="deviceDaemon_8cpp.html#7567931fa56e4616002507599be302e9">runEmbedded</a>);
<a name="l00033"></a>00033    boost::thread bg(<a class="code" href="clientDaemon_8cpp.html#0ee660fd919ae2d40b3121233169ee00">runDataLayer</a>);
<a name="l00034"></a>00034 
<a name="l00035"></a>00035    <span class="keywordflow">if</span> ( !bg.joinable() || !fg.joinable() )
<a name="l00036"></a>00036          <a class="code" href="auc-cd_8h.html#b497b0c636c3df3eaf60698ac8a89c0c">theseLogs</a>.<a class="code" href="classcdLogger.html#c8209410afb905787efbd8f49499523b">logN</a>(0,<span class="stringliteral">"Failed to start MD thread group."</span>);
<a name="l00037"></a>00037    <span class="keywordflow">else</span> {<a class="code" href="auc-cd_8h.html#b497b0c636c3df3eaf60698ac8a89c0c">theseLogs</a>.<a class="code" href="classcdLogger.html#c8209410afb905787efbd8f49499523b">logN</a>(0,<span class="stringliteral">"MD thread group started OK."</span>);
<a name="l00038"></a>00038          <a class="code" href="md__device_8h.html#9b79ae2abaf2e6362e09247c3b49c8bf">bgThreadGroup</a> = &amp;fg;
<a name="l00039"></a>00039          <a class="code" href="md__device_8h.html#ebc1ed863d3000bb5b7f0d3f3a16b3cc">dataLayer</a>     = &amp;bg;
<a name="l00040"></a>00040         }         
<a name="l00041"></a>00041   }
<a name="l00042"></a>00042   <span class="keywordflow">catch</span> (std::exception &amp;e)
<a name="l00043"></a>00043   {
<a name="l00044"></a>00044       <a class="code" href="auc-cd_8h.html#b497b0c636c3df3eaf60698ac8a89c0c">theseLogs</a>.<a class="code" href="classcdLogger.html#c8209410afb905787efbd8f49499523b">logN</a>(1,<span class="stringliteral">"Exception: %s"</span>,e.what());      
<a name="l00045"></a>00045   }
<a name="l00046"></a>00046   <span class="keywordflow">catch</span> (...) {
<a name="l00047"></a>00047       <a class="code" href="auc-cd_8h.html#b497b0c636c3df3eaf60698ac8a89c0c">theseLogs</a>.<a class="code" href="classcdLogger.html#c8209410afb905787efbd8f49499523b">logN</a>(0,<span class="stringliteral">"General fault."</span>);
<a name="l00048"></a>00048   }
<a name="l00049"></a>00049   <span class="keywordflow">return</span> value;
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 <span class="keywordtype">void</span> mdEmbeddedAPI::mdCmdResult(<span class="keywordtype">int</span> rc) {
<a name="l00053"></a>00053 
<a name="l00054"></a>00054  <span class="keywordflow">if</span> (rc == <a class="code" href="mdconstants_8h.html#ba51915c87d64af47fb1cc59348961c9">OK</a>) {
<a name="l00055"></a>00055 
<a name="l00056"></a>00056  } <span class="keywordflow">else</span> {
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 
<a name="l00059"></a>00059  }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 <span class="keywordtype">int</span> mdEmbeddedAPI::mdRegisterCommandCallback(<span class="keywordtype">void</span> (f)(<span class="keywordtype">char</span> *,<span class="keywordtype">char</span> *), <span class="keyword">const</span> <span class="keywordtype">char</span> *canonicalSCPI) {
<a name="l00064"></a>00064 
<a name="l00065"></a>00065  boost::unique_lock&lt;boost::mutex&gt; cmdRegResponse(<a class="code" href="deviceDaemon_8cpp.html#d2a7ce1ced9c7eea9c156d50f7d69e7f">mdQuery</a>);
<a name="l00066"></a>00066  <a class="code" href="classdvQueryMD.html">dvQueryMD</a>                                       checkCmd;
<a name="l00067"></a>00067  <span class="keywordtype">int</span> value=<a class="code" href="mdconstants_8h.html#ba51915c87d64af47fb1cc59348961c9">OK</a>;
<a name="l00068"></a>00068 
<a name="l00069"></a>00069  <a class="code" href="deviceDaemon_8cpp.html#e12b69b7916e6e2829e3865145ba6cda">setStrMsg</a>(checkCmd.<a class="code" href="classdvQueryMD.html#b5b307bdffa1a3f6e2563cb9cce9561d">mdg</a>,canonicalSCPI,<a class="code" href="mdcommon_8h.html#fcc5cc24102ccd9a8e45227ea5ddeddd16426520294c565b9ac1ef453643d16c">MDDG_MDQUERY</a>,<a class="code" href="mdcommon_8h.html#fcc5cc24102ccd9a8e45227ea5ddeddd313d9a531a6ac7971d9408d9ace08526">MDDG_REGSCPI</a>,<a class="code" href="auc-cd_8h.html#e73e5747d151dd3f1a0b8ba29bfaa3e6">thisConfig</a>-&gt;<a class="code" href="classclientDaemonConfig.html#2756f3393910563f56e513dbea4bc575">deviceName</a>.c_str());
<a name="l00070"></a>00070  checkCmd.<a class="code" href="classdvQueryMD.html#b5b307bdffa1a3f6e2563cb9cce9561d">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#bbaa18fe526725a0469dde6e69d5e411">handle</a> = checkCmd.<a class="code" href="classdvQueryMD.html#b5b307bdffa1a3f6e2563cb9cce9561d">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#22c2014a5093cfe50a41ff548b889e5d">sourceHandle</a> = <a class="code" href="md__device_8h.html#5082e343693c78b016c4c0be6327547e">thisDevice</a>-&gt;<a class="code" href="classmdEmbedded.html#a38484f52e90e70feee1b4aa1593e1d2">myHandle</a>;
<a name="l00071"></a>00071  <a class="code" href="md__device_8h.html#6cb7441c452930a994ea391dcf70fc7d">thisCmdQry</a>.<a class="code" href="structmdDialog.html#20058264797bc0293668eb609b721fbc">call</a>            = &amp;checkCmd;
<a name="l00072"></a>00072  checkCmd.<a class="code" href="classdvQueryMD.html#39280f16f2ff14470865d981c51edc9f">send</a>();
<a name="l00073"></a>00073  <a class="code" href="deviceDaemon_8cpp.html#ce6d1703ac51bcc1d544eca186b40557">mdCmdQPending</a>.wait(cmdRegResponse);
<a name="l00074"></a>00074 
<a name="l00075"></a>00075  <span class="keywordflow">if</span> (<a class="code" href="md__device_8h.html#6cb7441c452930a994ea391dcf70fc7d">thisCmdQry</a>.<a class="code" href="structmdDialog.html#eebeb7a11148264fa46c0d0cfc278372">response</a>-&gt;<a class="code" href="classdvIncoming.html#f96580e8bd0ed549434ce539a9c0fa3e">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#0018718733130a6c766e25e8e27e36bf">dgType</a>.<a class="code" href="structMD__DG__TYPE.html#b82a8937d241682c2a5e6d2305b8ee44">value</a>) {
<a name="l00076"></a>00076 
<a name="l00077"></a>00077    <a class="code" href="structmdCmdPOD.html">mdCmdPOD</a>              *flattened = (<a class="code" href="structmdCmdPOD.html">mdCmdPOD</a> *)(&amp;<a class="code" href="md__device_8h.html#6cb7441c452930a994ea391dcf70fc7d">thisCmdQry</a>.<a class="code" href="structmdDialog.html#eebeb7a11148264fa46c0d0cfc278372">response</a>-&gt;<a class="code" href="classdvIncoming.html#f96580e8bd0ed549434ce539a9c0fa3e">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#3364f693abdd6e187306374f33d5f9bf">payLoad</a>[0]);
<a name="l00078"></a>00078    <a class="code" href="classmdCommand.html">mdCommand</a>                *gotten = <span class="keyword">new</span> <a class="code" href="classmdCommand.html">mdCommand</a>();
<a name="l00079"></a>00079    <span class="keywordtype">char</span>                       *sVal = &amp;flattened-&gt;<a class="code" href="structmdCmdPOD.html#c0a1e6689319854103d2ee4e15723828">sVal</a>;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081    memcpy(&amp;gotten-&gt;<a class="code" href="classmdCommand.html#6033e0caeeb6c502303f87eff6310d0d">parms</a>,&amp;flattened,<span class="keyword">sizeof</span>(<a class="code" href="structmdCmdPOD.html">mdCmdPOD</a>));
<a name="l00082"></a>00082    gotten-&gt;<a class="code" href="classmdCommand.html#8a1325fd2bf59e9304ee94394f0b423d">signature</a>                  = std::string(sVal);
<a name="l00083"></a>00083    <a class="code" href="md__device_8h.html#e4700f8cc6b6fb1ccf9e06b02e0adb5b">mySCPI</a>[std::string(canonicalSCPI)] = gotten;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085  } <span class="keywordflow">else</span> 
<a name="l00086"></a>00086    value = <a class="code" href="md__device_8h.html#6cb7441c452930a994ea391dcf70fc7d">thisCmdQry</a>.<a class="code" href="structmdDialog.html#eebeb7a11148264fa46c0d0cfc278372">response</a>-&gt;<a class="code" href="classdvIncoming.html#f96580e8bd0ed549434ce539a9c0fa3e">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#67b07766585ef17cc7d6b2c1ed295e41">ec</a>;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088  <span class="keywordflow">return</span> value;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 <span class="keywordtype">bool</span> mdEmbeddedAPI::mdResume() {
<a name="l00092"></a>00092 
<a name="l00093"></a>00093  <span class="keywordtype">bool</span>   value=<span class="keyword">false</span>;
<a name="l00094"></a>00094  <span class="keywordflow">return</span> value;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 <a class="code" href="classmdOperationalDataElement.html">mdOperationalDataElement</a> *mdEmbeddedAPI::mdRegisterODE(<span class="keyword">const</span> <span class="keywordtype">char</span> *name) {
<a name="l00098"></a>00098 
<a name="l00099"></a>00099  boost::unique_lock&lt;boost::mutex&gt;                            ODERegResponse(<a class="code" href="deviceDaemon_8cpp.html#d2a7ce1ced9c7eea9c156d50f7d69e7f">mdQuery</a>);
<a name="l00100"></a>00100  <a class="code" href="classmdOperationalDataElement.html">mdOperationalDataElement</a> *value = NULL, *candidate = <span class="keyword">new</span> <a class="code" href="classmdOperationalDataElement.html">mdOperationalDataElement</a>();
<a name="l00101"></a>00101  <a class="code" href="classdvQueryMD.html">dvQueryMD</a>                                                                    regODE;
<a name="l00102"></a>00102  <span class="keywordtype">int</span>                                                                          nthODE;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104  <span class="keywordflow">if</span> (!<a class="code" href="md__device_8h.html#5082e343693c78b016c4c0be6327547e">thisDevice</a>-&gt;<a class="code" href="classmdEmbedded.html#a38484f52e90e70feee1b4aa1593e1d2">myHandle</a>)         {<a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a>-&gt;<a class="code" href="classmdError.html#bc44bee63f263a3ba7d16579a346ac2c">set</a>(1); <span class="keywordflow">goto</span> done;}
<a name="l00105"></a>00105  <span class="keywordflow">if</span> (!<a class="code" href="auc-cd_8h.html#e73e5747d151dd3f1a0b8ba29bfaa3e6">thisConfig</a>-&gt;cdConnected)      {<a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a>-&gt;<a class="code" href="classmdError.html#bc44bee63f263a3ba7d16579a346ac2c">set</a>(2); <span class="keywordflow">goto</span> done;}
<a name="l00106"></a>00106 
<a name="l00107"></a>00107  <a class="code" href="deviceDaemon_8cpp.html#e12b69b7916e6e2829e3865145ba6cda">setStrMsg</a>(regODE.<a class="code" href="classdvQueryMD.html#b5b307bdffa1a3f6e2563cb9cce9561d">mdg</a>,name,<a class="code" href="mdcommon_8h.html#fcc5cc24102ccd9a8e45227ea5ddeddd16426520294c565b9ac1ef453643d16c">MDDG_MDQUERY</a>,<a class="code" href="mdcommon_8h.html#fcc5cc24102ccd9a8e45227ea5ddeddd2b95ed0adf749ed643904e9976170548">MDDG_REGODE</a>,<a class="code" href="auc-cd_8h.html#e73e5747d151dd3f1a0b8ba29bfaa3e6">thisConfig</a>-&gt;<a class="code" href="classclientDaemonConfig.html#2756f3393910563f56e513dbea4bc575">deviceName</a>.c_str());
<a name="l00108"></a>00108  regODE.<a class="code" href="classdvQueryMD.html#b5b307bdffa1a3f6e2563cb9cce9561d">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#bbaa18fe526725a0469dde6e69d5e411">handle</a> = regODE.<a class="code" href="classdvQueryMD.html#b5b307bdffa1a3f6e2563cb9cce9561d">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#22c2014a5093cfe50a41ff548b889e5d">sourceHandle</a> = <a class="code" href="md__device_8h.html#5082e343693c78b016c4c0be6327547e">thisDevice</a>-&gt;<a class="code" href="classmdEmbedded.html#a38484f52e90e70feee1b4aa1593e1d2">myHandle</a>;
<a name="l00109"></a>00109  <a class="code" href="md__device_8h.html#222fe5ba41d1b1512b4ee748d1a4a4fb">thisODEQry</a>.<a class="code" href="structmdDialog.html#20058264797bc0293668eb609b721fbc">call</a>          = &amp;regODE;
<a name="l00110"></a>00110  regODE.<a class="code" href="classdvQueryMD.html#39280f16f2ff14470865d981c51edc9f">send</a>();
<a name="l00111"></a>00111  <a class="code" href="deviceDaemon_8cpp.html#964c4495a2919228f61898e2197a7453">mdODEQPending</a>.wait(ODERegResponse);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113  <span class="keywordflow">if</span> (<a class="code" href="md__device_8h.html#222fe5ba41d1b1512b4ee748d1a4a4fb">thisODEQry</a>.<a class="code" href="structmdDialog.html#eebeb7a11148264fa46c0d0cfc278372">response</a>-&gt;<a class="code" href="classdvIncoming.html#f96580e8bd0ed549434ce539a9c0fa3e">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#0018718733130a6c766e25e8e27e36bf">dgType</a>.<a class="code" href="structMD__DG__TYPE.html#b82a8937d241682c2a5e6d2305b8ee44">value</a>) {
<a name="l00114"></a>00114 
<a name="l00115"></a>00115    <a class="code" href="structmdODEPOD.html" title="mdState Root class of Data Model.">mdODEPOD</a>              *flattened = (<a class="code" href="structmdODEPOD.html" title="mdState Root class of Data Model.">mdODEPOD</a> *)(&amp;<a class="code" href="md__device_8h.html#222fe5ba41d1b1512b4ee748d1a4a4fb">thisODEQry</a>.<a class="code" href="structmdDialog.html#eebeb7a11148264fa46c0d0cfc278372">response</a>-&gt;<a class="code" href="classdvIncoming.html#f96580e8bd0ed549434ce539a9c0fa3e">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#3364f693abdd6e187306374f33d5f9bf">payLoad</a>[0]);
<a name="l00116"></a>00116    <a class="code" href="structmdODEPOD.html" title="mdState Root class of Data Model.">mdODEPOD</a>                 *shared = &amp;<a class="code" href="auc-cd_8h.html#142a67f8a8d114b1e6eddf992e024539">gm</a>-&gt;opsdata[(nthODE=<a class="code" href="auc-cd_8h.html#142a67f8a8d114b1e6eddf992e024539">gm</a>-&gt;nODEs++)];
<a name="l00117"></a>00117    <a class="code" href="auc-cd_8h.html#142a67f8a8d114b1e6eddf992e024539">gm</a>-&gt;odes[nthODE]                 = std::string(name);
<a name="l00118"></a>00118    <a class="code" href="classmdOperationalDataElement.html">mdOperationalDataElement</a> *gotten = <span class="keyword">new</span> <a class="code" href="classmdOperationalDataElement.html">mdOperationalDataElement</a>(shared);
<a name="l00119"></a>00119    <span class="keywordtype">char</span>                       *sVal = &amp;flattened-&gt;<a class="code" href="structmdODEPOD.html#a7f380794ba4723179606d6b110a470e">sVal</a>;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121    memcpy(&amp;gotten-&gt;<a class="code" href="classmdOperationalDataElement.html#83f57d79c04cc4759bd780ac607dd1c2">ode</a>,&amp;flattened,<span class="keyword">sizeof</span>(<a class="code" href="structmdODEPOD.html" title="mdState Root class of Data Model.">mdODEPOD</a>));
<a name="l00122"></a>00122    gotten-&gt;<a class="code" href="classmdOperationalDataElement.html#27bd968d60919fd03622fd6616942385">stringValue</a>              = std::string(sVal);
<a name="l00123"></a>00123    <a class="code" href="md__device_8h.html#3d50ae0fe9917226bf4769b381fd7bfe">myODEs</a>[std::string(name)]        = value = gotten;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125  } <span class="keywordflow">else</span> 
<a name="l00126"></a>00126    <a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a>-&gt;<a class="code" href="classmdError.html#bc44bee63f263a3ba7d16579a346ac2c">set</a>(<a class="code" href="md__device_8h.html#222fe5ba41d1b1512b4ee748d1a4a4fb">thisODEQry</a>.<a class="code" href="structmdDialog.html#eebeb7a11148264fa46c0d0cfc278372">response</a>-&gt;<a class="code" href="classdvIncoming.html#f96580e8bd0ed549434ce539a9c0fa3e">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#67b07766585ef17cc7d6b2c1ed295e41">ec</a>);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128  done: <span class="keywordflow">return</span> value;
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 <a class="code" href="classmdObservable.html" title="mdObservable Low level Data Encapsulation.">mdObservable</a> *mdEmbeddedAPI::mdRegisterObservable(<span class="keyword">const</span> <span class="keywordtype">char</span> *name) {
<a name="l00131"></a>00131 
<a name="l00132"></a>00132  boost::unique_lock&lt;boost::mutex&gt;    obsRegResponse(<a class="code" href="deviceDaemon_8cpp.html#d2a7ce1ced9c7eea9c156d50f7d69e7f">mdQuery</a>);
<a name="l00133"></a>00133  <a class="code" href="classmdObservable.html" title="mdObservable Low level Data Encapsulation.">mdObservable</a> *value = NULL, *candidate = <span class="keyword">new</span> <a class="code" href="classmdObservable.html" title="mdObservable Low level Data Encapsulation.">mdObservable</a>();
<a name="l00134"></a>00134  <a class="code" href="classdvQueryMD.html">dvQueryMD</a>                                            regObs;
<a name="l00135"></a>00135  <span class="keywordtype">int</span>                                                  nthObs;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137  <span class="keywordflow">if</span> (!<a class="code" href="md__device_8h.html#5082e343693c78b016c4c0be6327547e">thisDevice</a>-&gt;<a class="code" href="classmdEmbedded.html#a38484f52e90e70feee1b4aa1593e1d2">myHandle</a>)         {<a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a>-&gt;<a class="code" href="classmdError.html#bc44bee63f263a3ba7d16579a346ac2c">set</a>(1); <span class="keywordflow">goto</span> done;}
<a name="l00138"></a>00138  <span class="keywordflow">if</span> (!<a class="code" href="auc-cd_8h.html#e73e5747d151dd3f1a0b8ba29bfaa3e6">thisConfig</a>-&gt;cdConnected)      {<a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a>-&gt;<a class="code" href="classmdError.html#bc44bee63f263a3ba7d16579a346ac2c">set</a>(2); <span class="keywordflow">goto</span> done;}
<a name="l00139"></a>00139 
<a name="l00140"></a>00140  <a class="code" href="deviceDaemon_8cpp.html#e12b69b7916e6e2829e3865145ba6cda">setStrMsg</a>(regObs.<a class="code" href="classdvQueryMD.html#b5b307bdffa1a3f6e2563cb9cce9561d">mdg</a>,name,<a class="code" href="mdcommon_8h.html#fcc5cc24102ccd9a8e45227ea5ddeddd16426520294c565b9ac1ef453643d16c">MDDG_MDQUERY</a>,<a class="code" href="mdcommon_8h.html#fcc5cc24102ccd9a8e45227ea5ddeddde383f96c612a9903b6cb2869d0c3a575">MDDG_REGOBS</a>,<a class="code" href="auc-cd_8h.html#e73e5747d151dd3f1a0b8ba29bfaa3e6">thisConfig</a>-&gt;<a class="code" href="classclientDaemonConfig.html#2756f3393910563f56e513dbea4bc575">deviceName</a>.c_str());
<a name="l00141"></a>00141  regObs.<a class="code" href="classdvQueryMD.html#b5b307bdffa1a3f6e2563cb9cce9561d">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#bbaa18fe526725a0469dde6e69d5e411">handle</a>   = regObs.<a class="code" href="classdvQueryMD.html#b5b307bdffa1a3f6e2563cb9cce9561d">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#22c2014a5093cfe50a41ff548b889e5d">sourceHandle</a> = <a class="code" href="md__device_8h.html#5082e343693c78b016c4c0be6327547e">thisDevice</a>-&gt;<a class="code" href="classmdEmbedded.html#a38484f52e90e70feee1b4aa1593e1d2">myHandle</a>;
<a name="l00142"></a>00142  <a class="code" href="md__device_8h.html#0133520f16e7c2bd0d266f7f9d37b18b">thisObsQry</a>.<a class="code" href="structmdDialog.html#20058264797bc0293668eb609b721fbc">call</a>            = &amp;regObs;
<a name="l00143"></a>00143  regObs.<a class="code" href="classdvQueryMD.html#39280f16f2ff14470865d981c51edc9f">send</a>();
<a name="l00144"></a>00144  <a class="code" href="deviceDaemon_8cpp.html#77ade0f201886e0de643f4ac654ead0d">mdObsQPending</a>.wait(obsRegResponse);
<a name="l00145"></a>00145  <span class="keywordflow">if</span> (<a class="code" href="md__device_8h.html#0133520f16e7c2bd0d266f7f9d37b18b">thisObsQry</a>.<a class="code" href="structmdDialog.html#eebeb7a11148264fa46c0d0cfc278372">response</a>-&gt;<a class="code" href="classdvIncoming.html#f96580e8bd0ed549434ce539a9c0fa3e">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#0018718733130a6c766e25e8e27e36bf">dgType</a>.<a class="code" href="structMD__DG__TYPE.html#b82a8937d241682c2a5e6d2305b8ee44">value</a>) {
<a name="l00146"></a>00146 
<a name="l00147"></a>00147    <a class="code" href="structmdObsPOD.html">mdObsPOD</a>     *flattened  = (<a class="code" href="structmdObsPOD.html">mdObsPOD</a> *)(&amp;<a class="code" href="md__device_8h.html#0133520f16e7c2bd0d266f7f9d37b18b">thisObsQry</a>.<a class="code" href="structmdDialog.html#eebeb7a11148264fa46c0d0cfc278372">response</a>-&gt;<a class="code" href="classdvIncoming.html#f96580e8bd0ed549434ce539a9c0fa3e">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#3364f693abdd6e187306374f33d5f9bf">payLoad</a>[0]);
<a name="l00148"></a>00148    <a class="code" href="structmdObsPOD.html">mdObsPOD</a>     *shared     = &amp;<a class="code" href="auc-cd_8h.html#142a67f8a8d114b1e6eddf992e024539">gm</a>-&gt;observations[(nthObs=<a class="code" href="auc-cd_8h.html#142a67f8a8d114b1e6eddf992e024539">gm</a>-&gt;nObs++)];
<a name="l00149"></a>00149    <a class="code" href="auc-cd_8h.html#142a67f8a8d114b1e6eddf992e024539">gm</a>-&gt;obs[nthObs]          = std::string(name);
<a name="l00150"></a>00150    <a class="code" href="classmdObservable.html" title="mdObservable Low level Data Encapsulation.">mdObservable</a> *gotten     = <span class="keyword">new</span> <a class="code" href="classmdObservable.html" title="mdObservable Low level Data Encapsulation.">mdObservable</a>(shared);
<a name="l00151"></a>00151    <span class="keywordtype">char</span>         *sVal       = &amp;flattened-&gt;<a class="code" href="structmdObsPOD.html#17622c9e5af8cabc72a33af552d04573">sVal</a>;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153    memcpy(&amp;gotten-&gt;<a class="code" href="classmdObservable.html#bfeefc824dfd483ba505542226e8a10f">obs</a>,&amp;flattened,<span class="keyword">sizeof</span>(<a class="code" href="structmdObsPOD.html">mdObsPOD</a>));
<a name="l00154"></a>00154    gotten-&gt;<a class="code" href="classmdObservable.html#fddc84e086fd412a3bc1e62a527b0f73">sValue</a>           = std::string(sVal);
<a name="l00155"></a>00155    <a class="code" href="md__device_8h.html#261a7cda9d94f04593e8f49e17e5d9a1">myObs</a>[std::string(name)] = value = gotten;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157  } <span class="keywordflow">else</span> 
<a name="l00158"></a>00158    <a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a>-&gt;<a class="code" href="classmdError.html#bc44bee63f263a3ba7d16579a346ac2c">set</a>(<a class="code" href="md__device_8h.html#0133520f16e7c2bd0d266f7f9d37b18b">thisObsQry</a>.<a class="code" href="structmdDialog.html#eebeb7a11148264fa46c0d0cfc278372">response</a>-&gt;<a class="code" href="classdvIncoming.html#f96580e8bd0ed549434ce539a9c0fa3e">mdg</a>.<a class="code" href="classmdDG.html#bc12b81f2722486b819e86c3f4fc93a1">dg</a>.<a class="code" href="structMD__DATAGRAM.html#291a1d2fb7d929c19670d021e6626401">hdr</a>.<a class="code" href="structMD__DG__HEADER.html#67b07766585ef17cc7d6b2c1ed295e41">ec</a>);
<a name="l00159"></a>00159 
<a name="l00160"></a>00160  done: <span class="keywordflow">return</span> value;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 }
<a name="l00163"></a>00163 <span class="keywordtype">bool</span> mdEmbeddedAPI::mdYield() {
<a name="l00164"></a>00164 
<a name="l00165"></a>00165  <span class="keywordtype">bool</span> value=<span class="keyword">true</span>;
<a name="l00166"></a>00166  <span class="keywordflow">return</span> value;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 <span class="keywordtype">void</span> mdEmbeddedAPI::setSingleton(<a class="code" href="structDV__TELEMETRY__DATA.html">auc_dv_global</a> *shared)
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171    <a class="code" href="md__device_8h.html#2ffab41f9ea0aa7e9e4d1ec56f1c506c">mdDDAPI</a> = <span class="keyword">this</span>; 
<a name="l00172"></a>00172   <span class="keywordflow">if</span> (!mdAddress.empty()) <a class="code" href="auc-cd_8h.html#e73e5747d151dd3f1a0b8ba29bfaa3e6">thisConfig</a>-&gt;<a class="code" href="classclientDaemonConfig.html#901c464ea592d7cea1121126538a510d">mdAddress</a> = mdAddress;
<a name="l00173"></a>00173   if (!mdPort.empty())    <a class="code" href="auc-cd_8h.html#e73e5747d151dd3f1a0b8ba29bfaa3e6">thisConfig</a>-&gt;mdPort    = mdPort;   
<a name="l00174"></a>00174   cdConnected   = &amp;<a class="code" href="auc-cd_8h.html#e73e5747d151dd3f1a0b8ba29bfaa3e6">thisConfig</a>-&gt;cdConnected;   
<a name="l00175"></a>00175   log           = &amp;<a class="code" href="auc-cd_8h.html#b497b0c636c3df3eaf60698ac8a89c0c">theseLogs</a>;                      
<a name="l00176"></a>00176   <a class="code" href="auc-cd_8h.html#142a67f8a8d114b1e6eddf992e024539">gm</a>            = shared;
<a name="l00177"></a>00177   <a class="code" href="auc-cd_8h.html#142a67f8a8d114b1e6eddf992e024539">gm</a>-&gt;nObs      = <a class="code" href="auc-cd_8h.html#142a67f8a8d114b1e6eddf992e024539">gm</a>-&gt;nODEs   = 0;
<a name="l00178"></a>00178 }
<a name="l00179"></a><a class="code" href="classmdEmbedded.html#eba25b9f3c54be89a1094cf96652ffd5">00179</a> <span class="keywordtype">void</span> <a class="code" href="classmdEmbedded.html#eba25b9f3c54be89a1094cf96652ffd5">mdEmbedded::additionalSystemMsgs</a>() {
<a name="l00180"></a>00180 
<a name="l00181"></a>00181    <a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a> = <span class="keyword">new</span> <a class="code" href="classmdError.html">mdError</a>();
<a name="l00182"></a>00182 
<a name="l00183"></a>00183    <a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a>-&gt;<a class="code" href="classmdError.html#8b120f0175f936fe8e218edb32a3ad8c">additionalSystemMsg</a>(1, <span class="stringliteral">"The device is not connected to the MD."</span>);
<a name="l00184"></a>00184    <a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a>-&gt;<a class="code" href="classmdError.html#8b120f0175f936fe8e218edb32a3ad8c">additionalSystemMsg</a>(2, <span class="stringliteral">"The device is not connected to the CD."</span>);
<a name="l00185"></a>00185    <a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a>-&gt;<a class="code" href="classmdError.html#8b120f0175f936fe8e218edb32a3ad8c">additionalSystemMsg</a>(10,<span class="stringliteral">"The data element is unknown to the MD."</span>);
<a name="l00186"></a>00186    <a class="code" href="md__device_8h.html#4caf627427fb2925aa61c15c11c1a4fc">mdErrors</a>-&gt;<a class="code" href="classmdError.html#8b120f0175f936fe8e218edb32a3ad8c">additionalSystemMsg</a>(20,<span class="stringliteral">"The SCPI command is unknown to the MD."</span>);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Jan 10 23:49:12 2011 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
